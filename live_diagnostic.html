<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Clip Tool Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-stethoscope"></i> Live Clip Tool Diagnostic</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Real-Time Analysis</h5>
                        <button onclick="runDiagnostic()" class="btn btn-primary btn-sm">
                            <i class="fas fa-play"></i> Run Diagnostic
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="diagnosticResults">
                            <p class="text-muted">Click "Run Diagnostic" to analyze the clip tool...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>üéØ Quick Tests</h5>
                    </div>
                    <div class="card-body">
                        <button onclick="testHomepage()" class="btn btn-info btn-sm mb-2 w-100">
                            <i class="fas fa-home"></i> Test Homepage
                        </button>
                        <button onclick="testCropper()" class="btn btn-warning btn-sm mb-2 w-100">
                            <i class="fas fa-crop"></i> Test Cropper.js
                        </button>
                        <button onclick="testClipSave()" class="btn btn-success btn-sm mb-2 w-100">
                            <i class="fas fa-save"></i> Test Clip Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>üìã Step-by-Step Test Results</h5>
            </div>
            <div class="card-body" id="stepResults">
                <p class="text-muted">Results will appear here...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    
    <script>
        function log(message, type = 'info', container = 'diagnosticResults') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': 'text-success',
                'error': 'text-danger', 
                'warning': 'text-warning',
                'info': 'text-info'
            };
            const icon = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            const element = document.getElementById(container);
            element.innerHTML += `<div class="${colors[type]} small">${icon[type]} [${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }
        
        function runDiagnostic() {
            document.getElementById('diagnosticResults').innerHTML = '';
            document.getElementById('stepResults').innerHTML = '';
            
            log('üîç Starting comprehensive clip tool diagnostic...', 'info');
            
            // Test 1: Basic JavaScript environment
            log('Testing JavaScript environment...', 'info');
            if (typeof console !== 'undefined') {
                log('Console available', 'success');
            } else {
                log('Console not available', 'error');
            }
            
            // Test 2: Required libraries
            log('Testing required libraries...', 'info');
            if (typeof jQuery !== 'undefined') {
                log('jQuery loaded (version: ' + jQuery.fn.jquery + ')', 'success');
            } else {
                log('jQuery not loaded', 'error');
            }
            
            if (typeof bootstrap !== 'undefined') {
                log('Bootstrap loaded', 'success');
            } else {
                log('Bootstrap not loaded', 'warning');
            }
            
            if (typeof Cropper !== 'undefined') {
                log('Cropper.js loaded', 'success');
            } else {
                log('Cropper.js not loaded', 'error');
            }
            
            // Test 3: Homepage connectivity
            testHomepage();
            
            // Test 4: Save clip endpoint
            setTimeout(() => testClipSave(), 1000);
        }
        
        function testHomepage() {
            log('Testing homepage accessibility...', 'info', 'stepResults');
            
            fetch('/epaper-site/')
                .then(response => {
                    if (response.ok) {
                        log('Homepage accessible (Status: ' + response.status + ')', 'success', 'stepResults');
                        return response.text();
                    } else {
                        log('Homepage error (Status: ' + response.status + ')', 'error', 'stepResults');
                    }
                })
                .then(html => {
                    if (html) {
                        // Check for key elements in the HTML
                        if (html.includes('clip-button')) {
                            log('Clip button found in HTML', 'success', 'stepResults');
                        } else {
                            log('Clip button NOT found in HTML', 'error', 'stepResults');
                        }
                        
                        if (html.includes('app.js')) {
                            log('app.js reference found in HTML', 'success', 'stepResults');
                        } else {
                            log('app.js reference NOT found in HTML', 'error', 'stepResults');
                        }
                        
                        if (html.includes('cropperjs')) {
                            log('Cropper.js reference found in HTML', 'success', 'stepResults');
                        } else {
                            log('Cropper.js reference NOT found in HTML', 'error', 'stepResults');
                        }
                    }
                })
                .catch(error => {
                    log('Homepage fetch error: ' + error.message, 'error', 'stepResults');
                });
        }
        
        function testCropper() {
            log('Testing Cropper.js functionality...', 'info', 'stepResults');
            
            // Create a test image
            const testImg = document.createElement('img');
            testImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzOThmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkRVTU1ZIElNQUdFPC90ZXh0Pjwvc3ZnPg==';
            testImg.style.maxWidth = '200px';
            testImg.onload = function() {
                try {
                    const cropper = new Cropper(testImg, {
                        viewMode: 1,
                        ready() {
                            log('Cropper.js test successful', 'success', 'stepResults');
                            cropper.destroy();
                        }
                    });
                } catch (error) {
                    log('Cropper.js test failed: ' + error.message, 'error', 'stepResults');
                }
            };
        }
        
        function testClipSave() {
            log('Testing save_clip.php endpoint...', 'info', 'stepResults');
            
            // Create a minimal test blob
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 50, 50);
            
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('image', blob, 'test.jpg');
                formData.append('edition_id', 1);
                formData.append('image_id', 1);
                
                fetch('/epaper-site/save_clip.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    log('Save endpoint responded (Status: ' + response.status + ')', response.ok ? 'success' : 'error', 'stepResults');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        log('Save endpoint working: ' + data.message, 'success', 'stepResults');
                    } else {
                        log('Save endpoint error: ' + data.message, 'error', 'stepResults');
                    }
                })
                .catch(error => {
                    log('Save endpoint fetch error: ' + error.message, 'error', 'stepResults');
                });
            }, 'image/jpeg', 0.9);
        }
        
        // Auto-run diagnostic on page load
        window.onload = function() {
            setTimeout(runDiagnostic, 500);
        };
    </script>
</body>
</html>
